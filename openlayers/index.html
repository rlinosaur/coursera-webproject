<!doctype html>
<html lang="en">
  <head> 

      <!--RLIN_MESSAGE
      НАЧАЛО КУСКА HTML <HEAD> ДЛЯ РАБОТЫ С КАРТОЙ
      Ссылки на библиотеки js и таблицы css можно заменить на внешние
      -->
      <!--
      <link rel="stylesheet" href="https://openlayers.org/en/v3.19.1/css/ol.css" type="text/css">
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
-->
      <link rel="stylesheet" href="css/ol.css" />
      <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
      .mapSubclades {
        height: 100%;
        width: 100%;
      }
       .subcladeControl {
        top: 65px;
        left: .5em;
      }
      .ol-touch .subcladeControl {
        top: 80px;
      }
    </style>
<!--
    <script src="https://openlayers.org/en/v3.19.1/build/ol.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
-->

    <script src="js/ol.js"></script>
    <script src="js/jquery-2.2.3.min.js"></script>    
    <script src="js/bootstrap.min.js"></script>
    <!--RLIN_MESSAGE
      КОНЕЦ КУСКА HTML <HEAD> ДЛЯ РАБОТЫ С КАРТОЙ-->   

    <style type="text/css" media="screen">
        #map_canvas {
            float: left;
            width: 79%;
            height: 600px;
            border: 1px solid #000;
        }
    </style>
    <title>OpenLayers 3 Subclades map test</title>
  </head>
  <body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://www.semargl.me/">YDNA</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="http://www.semargl.me/hg-maps/#">Home</a></li>
                <li><a href="http://www.semargl.me/search/">Search</a></li>

                <li><a href="http://www.semargl.me/haplogroups/">Haplogroups</a></li>
                <li class="dropdown">
                    <a href="http://www.semargl.me/hg-maps/#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Tools <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="http://www.semargl.me/tools/build-tree-and-asd-pairs/">Tree</a></li>
                        <li><a href="http://www.semargl.me/plot-matches/">Plot</a></li>
                    </ul>
                </li>
                
            </ul>

            <p class="navbar-text navbar-right">
                
                    <a href="http://www.semargl.me/login/" class="navbar-link">Login</a>
                    
            </p>
            </div><!--/.nav-collapse -->
        </div>
        </nav>
        <div class="container" role="main" style="height:100%;">    
            <h1>Общая карта гаплогрупп и их субкладов (ветвей)</h1><p>дает представление о числе и разнообразии представителей, из числа протестированных, в тех или иных странах и регионах.</p>
            <div id="map_canvas" style="position: relative; overflow: hidden;">              
              <!--RLIN_MESSAGE
            НАЧАЛО КУСКА HTML ДЛЯ РАБОТЫ С КАРТОЙ-->            
            
            <div id="mapSubclades" class="mapSubclades">
              <div id="mapPopupMarker"></div>        
            </div>
            
            <!--RLIN_MESSAGE
            КОНЕЦ КУСКА HTML  ДЛЯ РАБОТЫ С КАРТОЙ-->              
            </div>
            <div id="message"></div>
        </div><!-- /.container -->
        <div class="container">
            <p>&nbsp;</p>
        </div><!-- /.container -->  

      
    <!--</div>-->

     
    <!--RLIN_MESSAGE
     НАЧАЛО JS-скрипта ДЛЯ РАБОТЫ С КАРТОЙ-->     
    <script type="text/javascript">

    //ВНИМАНИЕ! НЕОБХОДИМО ЭКРАНИРОВАТЬ КАВЫЧКИ В НАЗВАНИЯХ СУБКЛАДОВ!
    //Хотя они только у Венедов. Но всё же.
    var subArray=[
           {subclade:"m129", name:'A-Unknown',color:"green"}
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"}          
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 

          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ,{subclade:"m1164",name:'R1b-P312 > Z40481 > ZZ11 > DF27/S250 > Z195/Z196',color:"rgba(180,120,34,0.5)"}
          ,{subclade:"m4",name:'R1a-Z92+, Y4459+, YP617+, YP569+ "Veneds"  (please, order R1a-Z280 SNP Pack)',color:"#2299cc"} 
          ];


    var styleCache = {};//Кэш стилей (на самом деле цветов). Должно ускорить работу.

    var markerLayers = new Array();//Пустой массив слоёв маркеров. Именовать будем по именам! (ибо нефиг, хотя...да, небольшие расчёты современному компу не повредят))) )
    /////////////////////////////////////////////////////////////////////////////////
    //ВНИМАНИЕ! ДАЛЕЕ СЛЕДУЕТ КУСОК КОДА, КОТОРЫЙ Я НЕ ПОНИМАЮ ИЛИ В КОТОРОМ ЛЕНЮСЬ РАЗБИРАТЬСЯ
    //Это из примеров OpenLayers 3. И оно работает!
    //СМЫСЛ. СОЗДАЁТСЯ КНОПКА И ВРОДЕ КАК ЧТО-ТО КУДА-ТО НАСЛЕДУЕТСЯ (возможно функция передаётся OpenLayers, а возможно и нет)
    //БУДЕТ ВРЕМЯ - РАЗБЕРИСЬ, ТУТ ИНТЕРЕСНО
    /////////////////////////////////////////////////////////////////////////////////
     window.appio = {};
      var app = window.appio;
      //
      // Define rotate to north control.
      //


      /**
       * @constructor Вот таким образом создаётся новый элемент управления OpenLayers
       * @extends {ol.control.Control}
       * @param {Object=} opt_options Control options.
       */
      app.SubcladesControl = function(opt_options) {        
        var options = opt_options || {};
        //var this_ = this;//Не пригодилось, но не всё ещё потеряно, правда ведь?             

        /////////////////////////////////////////////
        //Это будет происходить при нажатии на кнопку Subclades
        /////////////////////////////////////////////
        var handleSubcladeControl = function()
        {
          var test=document.getElementById('divSubcladesControl');
          if(test.style.display==='none') test.style.display='block';
            else test.style.display='none';          
          //map.removeLayer(vectorLayer);//Работаит, впрочем и должно было.
        }; 

        ///////////////////////////
        //А вот и сама кнопка
        ///////////////////////////
        var button = document.createElement('button');
        button.innerHTML = 'Subclades';
        button.style.width='100%';
        button.id='SubcladesControlButton';//Понадобится на случай перевода        
        button.addEventListener('click', handleSubcladeControl, false);
        button.addEventListener('touchstart', handleSubcladeControl, false);


        var divSubcladesControl = document.createElement('div');        
        divSubcladesControl.id='divSubcladesControl';//Пригодится для удаления чекбоксов.
        divSubcladesControl.style.display='none';
        divSubcladesControl.style.width='100%';
        var mapElmnt=document.getElementById('mapSubclades');
        //Скорее всего фишка в том, что попробовал узнать размер карты раньше, чем карта появилась.
        /*
        if(mapElmnt!==undefined)
            divSubcladesControl.style.height=(mapElmnt.offsetHeight-100)+'px';        
        else
            divSubcladesControl.style.height='500px';          
          */
        divSubcladesControl.style.height='480px';
        //divSubcladesControl.style.height='900px';
        divSubcladesControl.style['background-color']='rgba(180,180,180,0.5)';
        //divSubcladesControl.style.overflow='auto';        
        divSubcladesControl.style['overflow-y']='scroll';
        divSubcladesControl.style['overflow-x']='auto';
      
        divSubcladesControl.appendChild(document.createElement("br"));
        var i;
        for(i=0;i<subArray.length;i++)
        {
          var checkbox = document.createElement('input');
          var label = document.createElement('label');          
          checkbox.type="checkbox";          
          checkbox.id="schk_"+subArray[i].subclade;
          checkbox.value=subArray[i].subclade;
          checkbox.onclick=function()
          {
            var this_=this;
            //Если существует, то всё равно удаляем (т.е. надо либо удалять совсем, либо удалять перед обновлением (что вряд ли случится, кстати.))
            if(markerLayers[this.value]!==undefined && markerLayers[this.value]!==undefined)
            {
                map.removeLayer(markerLayers[this.value]);
                markerLayers[this.value]={};//отсутствует...как бы даже не undefined.                
            }
            if(this.checked===false) return;

            var lbl=document.getElementById('l_'+this.value);
            if(lbl.innerHTML==='') lbl.innerHTML='?Unknown';
            var fSym=lbl.innerHTML.charAt(0);
            var lCol=lbl.style.color;            
            //Итак: формат запроса есть. первая буква есть, цвет есть.
            //Надо: выполнить запрос, сграбить результат, отобразить на экране. просто как ... орбит дверная ручка.
            $.ajax
            ({
              url:'http://www.semargl.me/hg-maps-data/',
              type:'GET',
              //type:'POST',
              //data:'vetka=1',
              data:'vetka='+this_.value,
              dataType:'html',
              cache:false,
              async:true,
              success:function(data)
              {
                  var dataParsed;
                  console.log(data);
                  try
                  {                    
                     dataParsed=JSON.parse(data.replace(/^\uFEFF/, ''));   
                  }
                  catch(e)
                  {
                    console.log('Ошибка при разборе сообщения:'+data+'\nОписание ошибки:'+e);
                  }
                  //console.log(dataParsed);

                  //Ну и вот тебе пожалуйста, три маркера.
                  if(dataParsed['status']===undefined || dataParsed['status']!='ok') return;
                  //console.log(dataParsed);
                  //console.log('passed');
                  //ну попробуем, почему б и нет                                                                     
                            
                            //console.log(markers);
                            //console.log('Markers count '+markers.length);


                            var markers=dataParsed.markers;
                            ///////////////////////////
                            //Тестовый массив Features
                            ///////////////////////////
                            var newFeatures = new Array(markers.length);
                            for (var i = 0; i < markers.length; ++i)
                            {        
                              newFeatures[i] = new ol.Feature({
                               // type: 'point',
                                name: "Kit #"+markers[i].kit,
                                color: lCol,
                                letter:fSym,
                                //geometry: new ol.geom.Point(ol.proj.fromLonLat([markers[i].lon,markers[i].lat]))
                                //geometry: new ol.geom.Point(ol.proj.transform([markers[i].lon, markers[i].lat], 'EPSG:4326', 'EPSG:3857'))
                                //geometry: new ol.geom.Point(ol.proj.transform([parseFloat(markers[i].lat), parseFloat(markers[i].lon)], 'EPSG:4326', 'EPSG:3857'))
                                geometry: new ol.geom.Point(ol.proj.transform([parseFloat(markers[i].lon), parseFloat(markers[i].lat)], 'EPSG:4326', 'EPSG:3857'))
                                });        
                            }                          

                            markerLayers[this_.value] = new ol.layer.Vector({
                              source: new ol.source.Vector({
                                features: newFeatures
                              })
                              ,
                              style: function(feature) {
                                //Отрисовывается в
                                var fColor = lCol;
                                var letter = fSym;
                                var style = styleCache[fColor];
                                if (!style) 
                                {
                                  style = new ol.style.Style({
                                    image: new ol.style.Circle({
                                      radius: 10,
                                      stroke: new ol.style.Stroke({
                                        color: '#fff'
                                      }),
                                      fill: new ol.style.Fill({
                                        color: fColor
                                      })
                                    }),
                                    text: new ol.style.Text({
                                      text: letter,
                                      fill: new ol.style.Fill({
                                        color: '#fff'
                                      })
                                    })
                                  });            
                                  styleCache[fColor] = style;        
                                }
                                return style;
                              }
                            });
                            map.addLayer(markerLayers[this_.value]);

                  //Тут готово, а там придумаем, что ещё делать-то.
                //console.log('ВОЗРАДЕУМСЯ!');
                //console.log(data);
                 //if(data.status!==undefined){               }
              },
              error:function(data)
              {                    
                console.log("Ошибка при выполнении скрипта:='"+JSON.stringify(data));

                
                var dataParsed;
                var dataTest='{"status": "ok", "markers": [{"lat": "35.8242226", "lon": "127.147957", "kit": "21243"}]}';
                  try
                  {                    
                     dataParsed=JSON.parse(dataTest.replace(/^\uFEFF/, ''));   
                  }
                  catch(e)
                  {
                    console.log('Ошибка при разборе сообщения:'+dataTest+'\nОписание ошибки:'+e);
                  }                  
                  //Ну и вот тебе пожалуйста, три маркера.
                  if(dataParsed['status']===undefined || dataParsed['status']!='ok') return;
                  console.log(dataParsed);
                  console.log('passed');
                  
                  //ну попробуем, почему б и нет
                            ///////////////////////////
                            //Тестовый массив маркеров
                            ///////////////////////////
                                                      
                            var markers = new Array();
  
                            var i;
                            for(i=0;i<50;i++)
                            {
                              var rancolor='rgba('+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+', 1.0)';
                              var letter = String.fromCharCode(65+parseInt(Math.random()*26));
                              //return letter.ToString();
                              markers.push({"counter":i,"color":rancolor,"name":"Marker #"+i,"lon":(Math.random()*30+30),"lat":(Math.random()*30+10),"letter":letter,"kit":("DebugData_"+i)});
                            }
                            

                            var markers=dataParsed.markers;

                            console.log(markers);
                            console.log('Markers count '+markers.length);


                            ///////////////////////////
                            //Тестовый массив Features
                            ///////////////////////////
                            var newFeatures = new Array(markers.length);
                            for (var i = 0; i < markers.length; ++i)
                            {     
                            /*   
                                console.log('markers!!:');
                                console.log('lat:'+markers[i].lat);
                                console.log('lon:'+markers[i].lon);
                                console.log('first:');
                                console.log(ol.proj.transform([markers[i].lat, 35.8242226], 'EPSG:4326', 'EPSG:3857'));
                                console.log('second:');
                                console.log(ol.proj.transform([parseFloat(markers[i].lat), parseFloat(markers[i].lon)], 'EPSG:4326', 'EPSG:3857'));
                                */
                              newFeatures[i] = new ol.Feature({
                               // type: 'point',
                                name: "Kit #"+markers[i].kit,
                                color: '#777777',
                                letter:'?',                                
                                //geometry: new ol.geom.Point(ol.proj.transform([markers[i].lat, markers[i].lon], 'EPSG:4326', 'EPSG:3857'))
                                //geometry: new ol.geom.Point(ol.proj.transform([markers[i].lat, 35.8242226], 'EPSG:4326', 'EPSG:3857'))
                                //geometry: new ol.geom.Point(ol.proj.fromLonLat([parseFloat(markers[i].lon),parseFloat(markers[i].lat)]))
                                //geometry: new ol.geom.Point(ol.proj.transform([parseFloat(markers[i].lat), parseFloat(markers[i].lon)], 'EPSG:4326', 'EPSG:3857'))
                                geometry: new ol.geom.Point(ol.proj.transform([parseFloat(markers[i].lon), parseFloat(markers[i].lat)], 'EPSG:4326', 'EPSG:3857'))
                                });        
                            }                          

                            markerLayers[this_.value] = new ol.layer.Vector({
                              source: new ol.source.Vector({
                                features: newFeatures
                              })
                              ,
                              style: function(feature) {
                                //Отрисовывается в
                                var fColor = '#777777';
                                var letter = '?';
                                var style = styleCache[fColor];
                                if (!style) 
                                {
                                  style = new ol.style.Style({
                                    image: new ol.style.Circle({
                                      radius: 10,
                                      stroke: new ol.style.Stroke({
                                        color: '#fff'
                                      }),
                                      fill: new ol.style.Fill({
                                        color: fColor
                                      })
                                    }),
                                    text: new ol.style.Text({
                                      text: letter,
                                      fill: new ol.style.Fill({
                                        color: '#fff'
                                      })
                                    })
                                  });            
                                  styleCache[fColor] = style;        
                                }
                                return style;
                              }
                            });
                            map.addLayer(markerLayers[this_.value]);
              }
  });


          }          
          label.id='l_'+subArray[i].subclade;          
          label.appendChild(document.createTextNode(subArray[i].name));          
          label.style.color=subArray[i].color;
          divSubcladesControl.appendChild(checkbox);
          divSubcladesControl.appendChild(label);
          divSubcladesControl.appendChild(document.createElement("br"));
        }

        var element = document.createElement('div');
        element.className = 'subcladeControl ol-unselectable ol-control';
        element.appendChild(button);
        element.appendChild(divSubcladesControl);

        ol.control.Control.call(this, {
          element: element,
          target: options.target
        });

      };
      ol.inherits(app.SubcladesControl, ol.control.Control);

      //КОНЕЦ СТРАННОГО КОДА
      ///////////////////////////

      ///////////////////////////
      //Главный объект OpenLayers
      //Создашь - и нет пути назад
      ///////////////////////////
      var map = new ol.Map({
        controls: ol.control.defaults({
          attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
            collapsible: false
          })
        }).extend([
          new app.SubcladesControl()
        ]),
        target: 'mapSubclades'});     
      

      map.setView(new ol.View({
        center: ol.proj.transform([37.36,55.45], 'EPSG:4326', 'EPSG:3857'),
        zoom: 4
        //,rotation: Math.PI / 5
      }));

      ////////////////////////////////////
      //Собственно, изображение карты
      ////////////////////////////////////
      var tileLayer=new ol.layer.Tile({
            source: new ol.source.OSM()            
          });      
      map.addLayer(tileLayer);
      //Как добавили, так и удалим!
      //map.removeLayer(tileLayer);

      /////////////////////////////////////////////
      //Всплываюсчее окно с текстом для маркера
      //Оверлей. Типа перекрывается.
      /////////////////////////////////////////////
      var element = document.getElementById('mapPopupMarker');
      var popup = new ol.Overlay({
        element: element,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -50]
      });
      map.addOverlay(popup);
   

      ///////////////////////////
      //Popup для маркеров
      ///////////////////////////
      map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
            function(feature) {
              return feature;
            });
        if (feature) {
          var coordinates = feature.getGeometry().getCoordinates();
          popup.setPosition(coordinates);          
          var popid=element.getAttribute('aria-describedby');
          if($('#'+popid+' .popover-content').html()===undefined)
          {
            $(element).popover({
              'placement': 'top',
              'html': true,              
              'content': feature.get('name')
            });            
            $(element).popover('show');           
            }
          else
          {
            $('#'+popid+' .popover-content').html(feature.get('name'));
          }
          
        } else {
          console.log('Destroy popover1');
          $(element).popover('destroy');
        }
      });


      //var coordTest=[{"lon":37.36,"lat":55.45},{"lon":80.36,"lat":80.45}];
      
      ///////////////////////////
      //Тестовый массив маркеров
      ///////////////////////////
/*
      var markers = new Array();

      
      var rancolor='rgba('+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+', 1.0)';       
         markers.push({"counter":i,"color":"green","name":"Marker #"+i,"Lon":(55.45),"Lat":(37.36),"letter":"M"});
          markers.push({"counter":i,"color":"red","name":"Marker #"+i,"Lon":(35.8242226),"Lat":(127.147957),"letter":"K"});
      var i;      
      //for(i=0;i<2;i++)
      //{
//        var rancolor='rgba('+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+', 1.0)';
        //var letter = String.fromCharCode(65+parseInt(Math.random()*26));        
        //markers.push({"counter":i,"color":rancolor,"name":"Marker #"+i,"Lon":(37.36),"Lat":(89.147957),"letter":letter});
      //}
      
     console.log(markers);
      //console.log('Markers count '+markers.length);

      ///////////////////////////
      //Тестовый массив Features
      ///////////////////////////
      var newFeatures = new Array(markers.length);
      for (var i = 0; i < markers.length; ++i)
      {        
        newFeatures[i] = new ol.Feature({
         // type: 'point',
          name: markers[i].name,
          color: markers[i].color,
          letter:markers[i].letter,
          //geometry: new ol.geom.Point(ol.proj.fromLonLat([markers[i].Lon,markers[i].Lat]))
          //geometry: new ol.geom.Point(ol.proj.transform(markers[i].Lat, markers[i].Lon, 'EPSG:4326', 'EPSG:3857'))
          geometry: new ol.geom.Point(ol.proj.transform([markers[i].Lat, markers[i].Lon], 'EPSG:4326', 'EPSG:3857'))
          //geometry: new ol.geom.Point(ol.proj.transform([markers[i].Lon, markers[i].Lat], 'EPSG:4326', 'EPSG:3857'))
          
          });        
      }

      var styleCache = {};//Кэш стилей (на самом деле цветов)

      var markersLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: newFeatures
        })
        ,
        style: function(feature) {
          //Отрисовывается в
          var fColor = feature.get('color');
          var letter = feature.get('letter');
          var style = styleCache[fColor];
          if (!style) 
          {
            style = new ol.style.Style({
              image: new ol.style.Circle({
                radius: 10,
                stroke: new ol.style.Stroke({
                  color: '#fff'
                }),
                fill: new ol.style.Fill({
                  color: feature.get('color')
                })
              }),
              text: new ol.style.Text({
                text: letter,
                fill: new ol.style.Fill({
                  color: '#fff'
                })
              })
            });            
            styleCache[fColor] = style;        
          }
          return style;
        }
      });
      map.addLayer(markersLayer);
  */
     //http://dev.openlayers.org/examples/markers.html - пример со встроенными кнопками. ага.

     //Как добавлять много-много флажков на карту:
     //https://openlayers.org/en/latest/examples/cluster.html
     //При желании оттуда же можно выцепить и оцветнение каждого кластера нужным цветом

     //Иконки с webGL!!!
     //не лучший вариант, наверное, но прикольно!
     //https://openlayers.org/en/latest/examples/icon-sprite-webgl.html

     //Кликабельные иконки. Элегантненько.
     //https://openlayers.org/en/latest/examples/icon.html

     //Прикольный пример со всплывающим окном
     //https://openlayers.org/en/latest/examples/popup.html
     //Что мы из него можем извлечь? Ну, пожалуй, ничего особенного.
     //Разве что использовать для отображения субкладов (типа нажал на кнопку - получи попап с субкладами). с прокруткой и всеми делами.
     //пожалуй это тоже вариант не хуже, чем выпадающий список. А может это как раз тот вариант, который и нужен.


     //Оверлеи здесь! (ну всякие штуки, которые надо или не надо отображать на карте)

     /*
     Ну вот, пока можно сделать кликабельные чекбоксы, например:
     функции, слои, вот это всё!
     ох, не знаю, маловато знаний, чтобы сделать круто. Но должно получиться.
     */
    </script>
    <!--RLIN_MESSAGE
     КОНЕЦ JS-скрипта ДЛЯ РАБОТЫ С КАРТОЙ--> 
  </body>
</html>