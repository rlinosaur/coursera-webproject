<!doctype html>
<html lang="en">
  <head>    
    <link rel="stylesheet" href="css/ol.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
      .map {
       /* height: 400px;
        width: 400px;*/
      }
       .rotate-north {
        top: 65px;
        left: .5em;
      }
      .ol-touch .rotate-north {
        top: 80px;
      }
    </style>
    <script src="js/ol.js"></script>
    <script src="js/jquery-2.2.3.min.js"></script>
    <!--<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>-->
    <script src="js/bootstrap.min.js"></script>
    <title>OpenLayers 3 Subclades map test</title>
  </head>
  <body>
    <h2>Supermap of subclades preview</h2>   
      <div id="map" class="map">
        <div id="mapPopupMarker"></div>        
      </div>      
    <!--</div>-->
    <script type="text/javascript">
    /////////////////////////////////////////////////////////////////////////////////
    //ВНИМАНИЕ! ДАЛЕЕ СЛЕДУЕТ КУСОК КОДА, КОТОРЫЙ Я НЕ ПОНИМАЮ ИЛИ В КОТОРОМ ЛЕНЮСЬ РАЗБИРАТЬСЯ
    //СМЫСЛ. СОЗДАЁТСЯ КНОПКА И ВРОДЕ КАК ЧТО-ТО КУДА-ТО НАСЛЕДУЕТСЯ (возможно функция передаётся OpenLayers, а возможно и нет)
    //БУДЕТ ВРЕМЯ - РАЗБЕРИСЬ, ТУТ ИНТЕРЕСНО
    /////////////////////////////////////////////////////////////////////////////////
     window.appio = {};
      var app = window.appio;
      //
      // Define rotate to north control.
      //


      /**
       * @constructor Вот таким образом создаётся новый элемент управления OpenLayers
       * @extends {ol.control.Control}
       * @param {Object=} opt_options Control options.
       */
      app.SubcladesControl = function(opt_options) {

        console.log("we are here, bro");
        var options = opt_options || {};
        //var this_ = this;//Не пригодилось, но не всё ещё потеряно, правда ведь?             

        /////////////////////////////////////////////
        //Это будет происходить при нажатии на кнопку Subclades
        /////////////////////////////////////////////
        var handleSubcladeControl = function()
        {
          var test=document.getElementById('divSubcladesControl');
          if(test.style.display==='none') test.style.display='block';
            else test.style.display='none';          
          //map.removeLayer(vectorLayer);//Работаит, впрочем и должно было.
        }; 

        ///////////////////////////
        //А вот и сама кнопка
        ///////////////////////////
        var button = document.createElement('button');
        button.innerHTML = 'Subclades';
        button.style.width='100%';
        button.id='SubcladesControlButton';//Понадобится на случай перевода        
        button.addEventListener('click', handleSubcladeControl, false);
        button.addEventListener('touchstart', handleSubcladeControl, false);


        var divSubcladesControl = document.createElement('div');        
        divSubcladesControl.id='divSubcladesControl';//Пригодится для удаления чекбоксов.
        divSubcladesControl.style.display='none';
        divSubcladesControl.style.width='500px';
        divSubcladesControl.style.height='500px';
        divSubcladesControl.style['background-color']='rgba(0x22, 0x99, 0xcc, .7)';
        divSubcladesControl.style.overflow='auto';
        //divSubcladesControl.innerHTML='Hello people!';
        divSubcladesControl.appendChild(document.createTextNode('Hello People!'));

        var buttonApply = document.createElement('button');
        buttonApply.innerHTML='Apply';
        buttonApply.style.width='50px';
        buttonApply.onclick=function(){alert('Sorry, function doesn\'t work yet. Please comeback later!');};
        divSubcladesControl.appendChild(buttonApply);

        divSubcladesControl.appendChild(document.createElement("br"));
        var i;
        for(i=0;i<7;i++)
        {
          var checkbox = document.createElement('input');
          var label = document.createElement('label');
          //he.innerHTML='"Subclade №'+i+'"';
          //he.value='"Subclade №'+i+'"';
          //he.setAttribute('value','My default value')
          checkbox.type="checkbox";          
          checkbox.id="subcladecheck_"+i;          
          label.htmlFor = checkbox.id;
          label.appendChild(document.createTextNode('Subclade №'+i));
          //label.style.color='rgba('+Math.random()*50+200 +', '+Math.random()*50+200+', '+Math.random()*50+200 +', .7)';          
          label.style.color='rgba('+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+', 1.0)';
          divSubcladesControl.appendChild(checkbox);
          divSubcladesControl.appendChild(label);
          divSubcladesControl.appendChild(document.createElement("br"));
        }

        var element = document.createElement('div');
        element.className = 'rotate-north ol-unselectable ol-control';
        element.appendChild(button);
        element.appendChild(divSubcladesControl);

        ol.control.Control.call(this, {
          element: element,
          target: options.target
        });

      };
      ol.inherits(app.SubcladesControl, ol.control.Control);

      //КОНЕЦ СТРАННОГО КОДА
      ///////////////////////////



    ///////////////////////////////////////////////////////////////
    //Стили. Пока для флажков. Но будут меняться. Кардинально.
    ///////////////////////////////////////////////////////////////
    var styles = {        
        'icon': new ol.style.Style({
          image: new ol.style.Icon({
            anchor: [0.5, 1],
            src: 'images/testflag_small.png'
          })       
        }),
        'point': new ol.style.Style({
          image: new ol.style.Icon({
            anchor: [0.5, 1],
            src: 'images/testflag_small.png'
          })       
        })
      };

      

      ///////////////////////////
      //Главный объект OpenLayers
      //Создашь - и нет пути назад
      ///////////////////////////
      var map = new ol.Map({
        controls: ol.control.defaults({
          attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
            collapsible: false
          })
        }).extend([
          new app.SubcladesControl()
        ]),
        target: 'map'});     
      

      map.setView(new ol.View({
        center: ol.proj.fromLonLat([37.36,55.45]),
        zoom: 4
        //,rotation: Math.PI / 5
      }));

      ////////////////////////////////////
      //Собственно, изображение карты
      ////////////////////////////////////
      var tileLayer=new ol.layer.Tile({
            source: new ol.source.OSM()            
          });      
      map.addLayer(tileLayer);

      ////////////////////////////////////
      //А тут у нас будут маркеры. Пока проект
      ////////////////////////////////////
      var startMarker = new ol.Feature({
        type: 'icon',
        name: 'Null Island',
        population: 1000,
        rainfall: 200,
        geometry: new ol.geom.Point(ol.proj.fromLonLat([37.41, 8.82]))
      });
      var endMarker = new ol.Feature({
        type: 'icon',
        name: 'Default city subclade',
        population: 3000,
        rainfall: 400,
        geometry: new ol.geom.Point(ol.proj.fromLonLat([37.36,55.45]))
      });     

      var testLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: [startMarker, endMarker]
        })
        ,
        style: function(feature) {          
          return styles[feature.get('type')];
        }
      });
      map.addLayer(testLayer);
      //Как добавили, так и удалим!
      //map.removeLayer(tileLayer);

      /////////////////////////////////////////////
      //Всплываюсчее окно с текстом для маркера
      //Оверлей. Типа перекрывается.
      /////////////////////////////////////////////
      var element = document.getElementById('mapPopupMarker');
      var popup = new ol.Overlay({
        element: element,
        positioning: 'bottom-center',
        stopEvent: false,
        offset: [0, -50]
      });
      map.addOverlay(popup);
   

      ///////////////////////////
      //Popup для маркеров
      ///////////////////////////
      map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
            function(feature) {
              return feature;
            });
        if (feature) {
          var coordinates = feature.getGeometry().getCoordinates();
          popup.setPosition(coordinates);
          console.log('Feature data');          
          console.log(feature.get('name'));
          var vass=feature.get('name');
          $(element).popover({
            'placement': 'top',
            'html': true,
            //'content': feature.get('name')
            'content': vass+'...yet can\'t reload content :('
          });
          //popup.setContent();
          //$(element).popover.setContent();
          $(element).popover('setContent');
          $(element).popover('show');
        } else {
          $(element).popover('destroy');
        }
      });


      
      ///////////////////////////
      //Тестовый массив маркеров
      ///////////////////////////
      var markers = new Array();
      var i;
      for(i=0;i<1000;i++)
      {
        var rancolor='rgba('+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+','+parseInt(200-Math.random()*200)+', 1.0)';
        var letter = String.fromCharCode(65+parseInt(Math.random()*26));
        //return letter.ToString();
        markers.push({"counter":i,"color":rancolor,"name":"Marker #"+i,"Lon":(Math.random()*30+10),"Lat":(Math.random()*30+30),"letter":letter});
      }
     // console.log(markers);
      //console.log('Markers count '+markers.length);

      ///////////////////////////
      //Тестовый массив Features
      ///////////////////////////
      var newFeatures = new Array(markers.length);
      for (var i = 0; i < markers.length; ++i)
      {        
        newFeatures[i] = new ol.Feature({
         // type: 'point',
          name: markers[i].name,
          color: markers[i].color,
          letter:markers[i].letter,
          geometry: new ol.geom.Point(ol.proj.fromLonLat([markers[i].Lon,markers[i].Lat]))
          });        
      }

      var styleCache = {};//Кэш стилей (на самом деле цветов)

      var markersLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: newFeatures
        })
        ,
        style: function(feature) {
          //Отрисовывается в
          var fColor = feature.get('color');
          var letter = feature.get('letter');
          var style = styleCache[fColor];
          if (!style) 
          {
            style = new ol.style.Style({
              image: new ol.style.Circle({
                radius: 10,
                stroke: new ol.style.Stroke({
                  color: '#fff'
                }),
                fill: new ol.style.Fill({
                  color: feature.get('color')
                })
              }),
              text: new ol.style.Text({
                text: letter,
                fill: new ol.style.Fill({
                  color: '#fff'
                })
              })
            });            
            styleCache[fColor] = style;        
          }
          return style;
        }
      });
      map.addLayer(markersLayer);
      
     //http://dev.openlayers.org/examples/markers.html - пример со встроенными кнопками. ага.

     //Как добавлять много-много флажков на карту:
     //https://openlayers.org/en/latest/examples/cluster.html
     //При желании оттуда же можно выцепить и оцветнение каждого кластера нужным цветом

     //Иконки с webGL!!!
     //не лучший вариант, наверное, но прикольно!
     //https://openlayers.org/en/latest/examples/icon-sprite-webgl.html

     //Кликабельные иконки. Элегантненько.
     //https://openlayers.org/en/latest/examples/icon.html

     //Прикольный пример со всплывающим окном
     //https://openlayers.org/en/latest/examples/popup.html
     //Что мы из него можем извлечь? Ну, пожалуй, ничего особенного.
     //Разве что использовать для отображения субкладов (типа нажал на кнопку - получи попап с субкладами). с прокруткой и всеми делами.
     //пожалуй это тоже вариант не хуже, чем выпадающий список. А может это как раз тот вариант, который и нужен.


     //Оверлеи здесь! (ну всякие штуки, которые надо или не надо отображать на карте)

    </script>
  </body>
</html>